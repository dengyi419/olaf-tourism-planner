# API 配額限制處理指南

## 問題說明

當您看到以下錯誤訊息時，表示 Gemini API 的配額已用完：

- **403 錯誤**：`API 配額已用完（Peak requests per day 超過限制）`
- **429 錯誤**：`API 請求次數過多（速率限制）`

## 錯誤類型區分

### 1. 速率限制（429 - Rate Limit）
- **原因**：短時間內發送太多請求
- **解決方案**：
  - 等待 10-30 秒後再試
  - 系統會自動重試（最多 3 次）
  - 避免快速連續點擊

### 2. 配額限制（403 - Quota Exceeded）
- **原因**：每日請求次數（RPD - Requests Per Day）已超過限制
- **解決方案**：
  - **等待 24 小時**：配額會在每天重置
  - **升級配額**：在 Google Cloud Console 升級您的 API 配額
  - **檢查配額使用情況**：訪問 https://makersuite.google.com/app/apikey

## 如何檢查配額

1. 訪問 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 登入您的 Google 帳號
3. 查看 API Key 的配額使用情況
4. 檢查以下限制：
   - **RPM** (Requests Per Minute)：每分鐘請求數
   - **RPD** (Requests Per Day)：每日請求數
   - **TPM** (Tokens Per Minute)：每分鐘 Token 數

## 免費配額限制

Gemini API 的免費配額通常包括：
- **RPM**：15 次/分鐘
- **RPD**：1,500 次/天（可能因地區而異）
- **TPM**：32,000 tokens/分鐘

## 升級配額

如果需要更高的配額：

1. 訪問 [Google Cloud Console](https://console.cloud.google.com/)
2. 選擇您的專案
3. 前往 **API 和服務** → **配額**
4. 找到 **Generative Language API**
5. 申請增加配額或升級到付費計劃

## 應用程式中的處理

應用程式已自動處理以下情況：

### 自動重試（僅限 429 錯誤）
- 遇到速率限制時，系統會自動重試
- 最多重試 3 次，每次間隔 5 秒
- 顯示重試進度

### 配額錯誤（403）
- 不會自動重試（因為需要等待 24 小時）
- 顯示清晰的錯誤訊息和解決方案
- 提供配額檢查連結

### 請求間隔保護
- 翻譯功能：最小間隔 2 秒
- 防止用戶快速連續點擊

## 最佳實踐

1. **合理使用**：
   - 避免頻繁測試
   - 批量處理時注意間隔

2. **監控使用情況**：
   - 定期檢查 API 配額使用情況
   - 設置使用提醒

3. **優化請求**：
   - 合併多個請求（如果可能）
   - 使用緩存避免重複請求

## 常見問題

### Q: 為什麼會超過配額？
A: 可能是：
- 多次測試功能
- 多個用戶共享同一個 API Key
- 自動重試導致請求數增加

### Q: 配額何時重置？
A: 通常是每天 UTC 00:00 重置，但具體時間可能因地區而異。

### Q: 可以申請更多配額嗎？
A: 可以，在 Google Cloud Console 申請增加配額或升級到付費計劃。

### Q: 多個用戶使用同一個 API Key 會怎樣？
A: 所有用戶共享同一個配額限制，建議每個用戶使用自己的 API Key。

## 技術細節

### 錯誤識別
應用程式會自動識別以下錯誤類型：
- `quota exceeded`
- `RPD` (Requests Per Day)
- `403` HTTP 狀態碼
- `429` HTTP 狀態碼

### 錯誤處理流程
1. 後端 API 捕獲錯誤
2. 識別錯誤類型（配額 vs 速率限制）
3. 返回適當的錯誤訊息和狀態碼
4. 前端根據錯誤類型決定是否重試
5. 顯示用戶友好的錯誤訊息

---

**最後更新**：2025-01-28

